<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Lines</title>
    <link rel="stylesheet" href="../css/style.css">
    <script type="text/javascript" src="../../dist/paper-full.js"></script>
    <script type="text/paperscript" canvas="canvas">
        var width = 1200,
            height = 700;

        var sample = poissonDiscSampler(width, height, 10);

        function poissonDiscSampler(width, height, radius) {
            var k = 30, // maximum number of samples before rejection
                radius2 = radius * radius,
                R = 3 * radius2,
                cellSize = radius * Math.SQRT1_2,
                gridWidth = Math.ceil(width / cellSize),
                gridHeight = Math.ceil(height / cellSize),
                grid = new Array(gridWidth * gridHeight),
                queue = [],
                queueSize = 0,
                sampleSize = 0;

            return function() {
                if (!sampleSize) return sample(Math.random() * width, Math.random() * height);

                // Pick a random existing sample and remove it from the queue.
                while (queueSize) {
                    var i = Math.random() * queueSize | 0,
                    s = queue[i];

                    // Make a new candidate between [radius, 2 * radius] from the existing sample.
                    for (var j = 0; j < k; ++j) {
                        var a = 2 * Math.PI * Math.random(),
                            r = Math.sqrt(Math.random() * R + radius2),
                            x = s[0] + r * Math.cos(a),
                            y = s[1] + r * Math.sin(a);

                    // Reject candidates that are outside the allowed extent,
                    // or closer than 2 * radius to any existing sample.
                    if (0 <= x && x < width && 0 <= y && y < height && far(x, y)) return sample(x, y);
                    }

                    queue[i] = queue[--queueSize];
                    queue.length = queueSize;
                }
            };

            function far(x, y) {
                var i = x / cellSize | 0,
                    j = y / cellSize | 0,
                    i0 = Math.max(i - 2, 0),
                    j0 = Math.max(j - 2, 0),
                    i1 = Math.min(i + 3, gridWidth),
                    j1 = Math.min(j + 3, gridHeight);

                for (j = j0; j < j1; ++j) {
                    var o = j * gridWidth;
                    for (i = i0; i < i1; ++i) {
                        if (s = grid[o + i]) {
                         var s,
                         dx = s[0] - x,
                         dy = s[1] - y;
                        if (dx * dx + dy * dy < radius2) return false;
                        }
                    }
                }

                return true;
            }

            function sample(x, y) {
                var s = [x, y];
                queue.push(s);
                grid[gridWidth * (y / cellSize | 0) + (x / cellSize | 0)] = s;
                ++sampleSize;
                ++queueSize;
                return s;
            }
        }

        // Code for an individual star. This is written in Paperjs.
        
        var amount = 45; // number of points in the star
        for (var i = 0; i < amount; i++) {
            var path = new Path({
                fillColor: {
                    hue: 1,
                    saturation: 1,
                    brightness: Math.random()
                },
                closed: true
            });
        }

        var position = view.center;
        var mousePos = view.center;
        var children = project.activeLayer.children;

        function iterate(count) {
            var delta = mousePos - position;
            position += delta / 10;
            for (var i = 1; i < amount; i++) {
                var path = children[i];
                var length = Math.abs(Math.sin(i + count / 40) * 300) / 3;
                path.segments = [
                    position + delta / 1.5,
                    position + { angle: i / amount * 360, length: length },
                    position + { angle: (i + 1) / amount * 360, length: length }
                ];
                path.fillColor.hue = count - length;
            }
        }

        function onFrame(event) {
            var starsSoFar = new Group();
            for (var i = 0; i < 10; i++) {
                  var s = sample();
                  //if (!s) return true;
                  var newStar = iterate(event.count / 2);
                  position = new Point(s[0], s[1]);
                  mousePos = position;
                  starsSoFar.addChild(newStar);
                  return starsSoFar;

            }
            
        }
    </script>
</head>
<body style="background:black">
    <canvas id="canvas" resize></canvas>
</body>
</html>
